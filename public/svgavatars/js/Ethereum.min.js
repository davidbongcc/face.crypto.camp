"use strict";var NODE_URL="https://frontier-lb.ether.camp",WEI_IN_ETH=new BigNumber("1000000000000000000"),GAS_MULTIPLIER=1.5,DEFAULT_GAS_LIMIT=2e4,EthUtil=window.modules.EthUtil,EthTx=window.modules.EthTx,rpcCall=function(e){if("[object Array]"===Object.prototype.toString.call(e))for(var r=0;r<e.length;r++)_.extendOwn(e[r],{jsonrpc:"2.0"});else _.extendOwn(e,{jsonrpc:"2.0"});return $.ajax({url:NODE_URL,type:"post",data:JSON.stringify(e),contentType:"application/json"})};window.modules.Ethereum={rpcCall:rpcCall,weiToEth:function(e){var r=new BigNumber(e,16);return r.div(WEI_IN_ETH).toNumber()},weiDecimalToEth:function(e){var r=new BigNumber(e);return r.div(WEI_IN_ETH).toNumber()},resToBigNumber:function(e){return e.result&&"0x"!==e.result?new BigNumber(e.result,16):new BigNumber(0)},resToEth:function(e){return e.result&&"0x"!==e.result?this.weiToEth(e.result):0},getBalance:function(e){var r=$.Deferred(),t=this;return t.rpcCall({id:1,method:"eth_getBalance",params:[window.modules.EthereumAddress.prefixed(e),"pending"]}).then(function(e){r.resolve(t.resToEth(e))},function(e){r.reject(e)}),r.promise},getNonce:function(e){var r=$.Deferred(),t=this;return t.rpcCall({id:1,method:"eth_getTransactionCount",params:[window.modules.EthereumAddress.prefixed(e),"pending"]}).then(function(e){r.resolve(t.resToBigNumber(e).toNumber())},function(e){r.reject(e)}),r.promise},getNonceAndPrice:function(e,r){var t=$.Deferred(),n=this;return n.rpcCall([{id:1,method:"eth_getTransactionCount",params:[window.modules.EthereumAddress.prefixed(e),"pending"]},{id:2,method:"eth_gasPrice",params:[window.modules.EthereumAddress.prefixed(e),"pending"]},{id:3,method:"eth_estimateGas",params:[{to:window.modules.EthereumAddress.prefixed(e),data:r}]}]).then(function(e){for(var r={},s=0;s<e.length;s++){var o=e[s];switch(o.id){case 1:r.nonce=n.resToBigNumber(o).toNumber();break;case 2:r.price=n.resToBigNumber(o).toNumber();break;case 3:r.gas=n.resToBigNumber(o).toNumber()}}t.resolve(r)},function(e){t.reject(e)}),t.promise},sendValue:function(e,r,t){return this.sendTx(e,r,t,null,21e3)},sendData:function(e,r,t,n,s){return this.sendTx(e,r,0,t,n,s)},createContract:function(e,r){return this.sendTx(null,e,0,r,39e5)},createTx:function(e){var r=$.Deferred();return{nonce:0,hash:"",status:"PENDING",message:"Pending",promise:e.promise,deferred:e,hashDeferred:r,hashPromise:r.promise}},sendTxAndReceiveHash:function(e,r,t,n,s,o,i){var a=$.Deferred(),u=this,d=window.web3?window.web3.eth.accounts[0]:window.modules.EthereumAddress.getFromPKey(s);return u.getNonceAndPrice(d,t)().then(function(d){if(void 0===i&&(i=d.nonce),e&&(e.nonce=i),window.web3)window.web3.eth.sendTransaction({nonce:i,gasLimit:o,gasPrice:5e10,to:null==r?null:window.modules.EthereumAddress.prefixed(r),value:n,data:t},function(e,r){a.resolve({error:e,result:r})});else{var l=new EthTx({nonce:i,gasLimit:o,gasPrice:5e10,to:null==r?null:window.modules.EthereumAddress.prefixed(r),value:n,data:t});l.sign(window.modules.EthUtil.toBuffer(window.modules.EthereumAddress.prefixed(s),"hex")),u.rpcCall({id:1,method:"eth_sendRawTransaction",params:["0x"+l.serialize().toString("hex")]}).then(function(e){a.resolve(e)},function(e){a.resolve(e)})}},function(e){a.resolve(e)}),a.promise},sendTx:function(e,r,t,n,s,o){void 0===o&&(o={}),void 0===o.statusCallback&&(o.statusCallback=successfulTxStatus);var i=$.Deferred(),a=this,u=a.createTx(i);return a.sendTxAndReceiveHash(u,e,n,t,r,s,o.nonce).then(function(e){return e.error||(u.hash=e.result,u.hashDeferred.resolve(u.hash)),e}).then(function(e){if(e.error)return u.status="REJECTED",u.message=e.error.message,u.deferred.resolve(u),!1;var r=Date.now(),t=$interval(function(){a.rpcCall({id:1,method:"eth_getTransactionReceipt",params:[u.hash]}).then(function(e){return Date.now()-r>12e5?($interval.cancel(t),u.status="REJECTED",u.message="Rejected by time out",u.deferred.resolve(u),!1):void(e.error||null==e.result||null==e.result.blockNumber||($interval.cancel(t),u.receipt=e.result,u.block=parseInt(u.receipt.blockNumber,16),o.statusCallback(u),u.deferred.resolve(u)))})},3e3)}),u},getTransactionReceipt:function(e){var r=$.Deferred(),t=Date.now(),n={},s=setInterval(function(){self.rpcCall({id:1,method:"eth_getTransactionReceipt",params:[e]}).then(function(e){return Date.now()-t>12e5?(clearInterval(s),n.status="REJECTED",n.message="Rejected by time out",n.deferred.resolve(n),!1):void(e.error||null==e.result||null==e.result.blockNumber||(clearInterval(s),n.receipt=e.result,n.block=parseInt(n.receipt.blockNumber,16),r.resolve(n)))})},3e3);return r}};